/*
 * com_provider.c
 * Interface for the data between Highlevel and Lowlevel Microcontroller Software
 *
 *  Created on: 14.11.2022
 *      Author: pasik
 */
#include "com_provider.h"
#include "usbd_cdc_if.h"


//extern USBD_HandleTypeDef hUsbDeviceFS;

static uint8_t buffer_in_use = 0;
volatile uint8_t receive_pending = 0;
uint8_t once = 0;
uint8_t buffer0status = 0;	//represent the actual status of the buffer (0 = buffer empty and ready for transmit, 1 = buffer full and ready for transmit)
uint8_t buffer1status = 1;	//
uint8_t buffer0[BUFFERSIZE];
uint8_t buffer1[BUFFERSIZE];

uint8_t is_receive_complete(){
	return CDC_Receive_Complete_FS();
}

/**
 * @brief
 *
 * @param Buffer
 * @param size
 */
void get_receive_message(uint8_t *Buffer, uint32_t size){
	if(is_receive_complete() != 0) {
		if(size > CDC_RX_BUFFER_SIZE){
			memcpy(Buffer, CDC_Receive_Data(), CDC_RX_BUFFER_SIZE);
		} else {
			memcpy(Buffer, CDC_Receive_Data(), size);
		}
		memset(CDC_Receive_Data(), 0x00, CDC_RX_BUFFER_SIZE);
	}
//	USBD_CDC_ReceivePacket(&hUsbDeviceFS);
}

uint8_t isBufferEmpty(uint8_t buffernumber)
{
	if(buffernumber == 1) {
		return buffer0status;
	} else if (buffernumber == 2) {
		return buffer1status;
	}
}

void setBuffer1(uint8_t *data)
{
	memcpy(buffer0, data, sizeof(buffer0));
}

void setBuffer2(uint8_t *data)
{
	memcpy(buffer1, data, sizeof(buffer1));
}
/**
 * @brief
 *
 * @return
 */
uint8_t transmit_ready(){
	uint8_t transmit_indicator = 0;
//
//	if(transmit_buffer1_status() == 1){
//
//	} else if(transmit_buffer2_status() == 1){
//
//	}
	return transmit_indicator;
}


void transmit_data(){
//	if(!once){
//		once = 1;
//		memset(buffer0, 'T', BUFFERSIZE);
//		memset(buffer1, '1', BUFFERSIZE);
//	}
	if(buffer_in_use == 0){
		if(CDC_Transmit_FS(buffer0, BUFFERSIZE) == USBD_OK){
			buffer_in_use = 1;
			memset(buffer0, '\0', BUFFERSIZE);
		} else {	//Capture USB Busy Errors and resent the given buffer the second time
			CDC_Transmit_FS(buffer0, BUFFERSIZE);
		}

	} else {
		if(CDC_Transmit_FS(buffer1, BUFFERSIZE) == USBD_OK){
			buffer_in_use = 0;
			memset(buffer1, '\0', BUFFERSIZE);
		} else {	//Capture USB Busy Errors and resent the given buffer the second time
			CDC_Transmit_FS(buffer1, BUFFERSIZE);
		}
	}
	//TODO
	//
	//
	//Nur f√ºr TESTZWECKE!!!
//	memset(buffer0, 'T', BUFFERSIZE);
//	memset(buffer1, '1', BUFFERSIZE);
}


